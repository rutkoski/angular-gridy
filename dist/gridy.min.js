"use strict";function collide(a,b){return a.col>b.col+b.cols-1||b.col>a.col+a.cols-1?!1:a.row>b.row+b.rows-1||b.row>a.row+a.rows-1?!1:!0}var IScroll=IScroll||{},interact=interact||{},eventjs=eventjs||{};Array.isArray||(Array.isArray=function(arg){return"[object Array]"===Object.prototype.toString.call(arg)});var __id=0;angular.module("rutkoski.angular-gridy",[]).constant("gridyConfig",{margin:10,gutter:10,maxRows:2,maxCols:3,mobileBreak:480,dragHandle:".gridy-drag-handle",resizeHandle:".gridy-resize-handle"}).controller("GridyCtrl",["gridyConfig",function(gridyConfig){this.maxCols=null,this.maxRows=null,this.gutter=null,this.margin=null,this.mobileBreak=null,this.$element=null,this.$inner=null,this.floating=!0,this.mobile=!1,this.scrollbarWidth=16,this.colWidth=null,this.rowHeight=null,this.pageWidth=null,this.pageHeight=null,this.grid=[],this.dragItem=null,this.interacting=!1,this.maxCol=-1,this.page=0,angular.extend(this,gridyConfig),this.setOptions=function(options){options&&(options=angular.extend({},options),angular.extend(this,options))},this.init=function($element){this.$element=$element,this.$inner=$element.find(".gridy-inner")},this.removeItem=function(item){this.grid[item.row]&&this.grid[item.row][item.col]===item&&delete this.grid[item.row][item.col],this.floatItems()},this.autoSetItemPosition=function(item){for(var pos={row:0,col:0,rows:item.rows,cols:item.cols};this.getItems(pos).length||!this.isInsidePage(pos);)pos.row=pos.row+1,pos.row>=this.maxRows&&(pos.row=0,pos.col=pos.col+1);this.setItemPosition(item,pos.row,pos.col)},this.isInsidePage=function(item){var page0=this.getPageFromCol(item.col),page1=this.getPageFromCol(item.col+item.cols-1);return page0===page1},this.setItemPosition=function(item,row,col){if(!this.mobile&&("undefined"==typeof item.oldRow||item.oldRow!==row||"undefined"==typeof item.oldCol||item.oldCol!==col)){if(this.grid[item.oldRow]&&this.grid[item.oldRow][item.oldCol]===item&&delete this.grid[item.oldRow][item.oldCol],isNaN(parseInt(row))||isNaN(parseInt(col)))return void this.autoSetItemPosition(item);item.oldRow=item.row=row,item.oldCol=item.col=col;var jump=this.getItems(item,item);if(this.moveOverlappingItems(item),this.grid[row]||(this.grid[row]=[]),this.grid[row][col]=item,this.updateMaxCol(),item===this.dragItem)for(;jump.length;)this.jumpFloatItem(jump.shift())}},this.setItemSize=function(item,rows,cols){if(!this.mobile){parseInt(cols)||(item.cols=1),parseInt(rows)||(item.rows=1);var page0=this.getPageFromCol(item.col),page1=this.getPageFromCol(item.col+cols-1);page0!==page1&&(cols=this.maxCols-(item.col-page0*this.maxCols)),item.rows=rows,item.cols=cols,this.moveOverlappingItems(item),this.updateMaxCol()}},this.floatItems=function(exclude){this.mobile||this.floating&&(exclude&&!Array.isArray(exclude)&&(exclude=[exclude]),this.gridWalk(function(_item){_item===this.dragItem||exclude&&-1!==exclude.indexOf(_item)||this.floatItem(_item,exclude)},this))},this.jumpFloatItem=function(item){if(!this.mobile&&item.floating){var pos,m,j=item.col;for(pos={row:item.row,col:item.col,rows:item.rows,cols:item.cols};j>=0;)pos.col=j,this.getItems(pos,item).length||(m=j),j--;m!==item.col&&this.setItemPosition(item,item.row,m)}},this.floatItem=function(item){if(!this.mobile&&item.floating){var _item,items,pos,j=item.col;for(pos={row:item.row,col:item.col,rows:item.rows,cols:item.cols};j>0;){if(pos.col=j-1,items=this.getItems(pos,item),items.length){for(j=0;items.length;){_item=items.pop(),j=Math.max(j,_item.col+_item.cols);var page0=this.getPageFromCol(j),page1=this.getPageFromCol(j+item.cols-1);page1>page0&&(j=this.maxCols*page1)}break}j--}j!==item.col&&this.setItemPosition(item,item.row,j)}},this.moveOverlappingItems=function(item){if(!this.mobile)for(var items=this.getItems(item,item);items.length;){var page0,page1,_item=items.shift(),col=item.col+item.cols;do page0=this.getPageFromCol(col),page1=this.getPageFromCol(col+_item.cols-1),this.setItemPosition(_item,_item.row,col),col++;while(page0!==page1)}},this.getItems=function(item,exclude){var items=[];return exclude&&!Array.isArray(exclude)&&(exclude=[exclude]),this.gridWalk(function(_item){exclude&&-1!==exclude.indexOf(_item)||!collide(item,_item)||items.push(_item)}),items},this.findClosestPosition=function(x,y){var row,col,page=this.getPage(x),relativeX=x-this.getPageOffset(page)-this.margin,relativeY=y-this.margin;row=Math.floor((relativeY-this.margin)/(this.rowHeight+this.gutter)),col=Math.floor((relativeX-this.margin)/(this.colWidth+this.gutter));var left=this.getX(col),right=this.getX(col+1),top=this.getY(row),bottom=this.getY(row+1);return row=bottom-y>y-top?row:row+1,col=right-x>x-left?col:col+1,col+=page*this.maxCols,{row:row,col:col}},this.gridWalk=function(callback,self){var i,j,row,item;for(i in this.grid){row=this.grid[i];for(j in row)item=row[j],callback.apply(self,[item,i,j])}},this.getPage=function(x){return Math.floor(x/this.pageWidth)},this.getPageFromCol=function(col){return Math.floor(col/this.maxCols)},this.getPageOffset=function(page){return page*this.pageWidth},this.getX=function(col){var page=this.getPageFromCol(col),pageOffset=this.getPageOffset(page),relativeCol=col-this.maxCols*page;return Math.round(pageOffset+this.margin+relativeCol*this.colWidth+relativeCol*this.gutter)},this.getY=function(row){return Math.round(this.margin+row*this.rowHeight+row*this.gutter)},this.updateMaxCol=function(){var maxCol=0;this.gridWalk(function(item){maxCol=Math.max(maxCol,item.col+item.cols-1)}),this.maxCol=maxCol},this.getInnerWidth=function(){return this.mobile?this.$element.find(".gridy-item").size()*this.pageWidth:this.getPageOffset(this.getPageFromCol(this.maxCol)+1)}}]).controller("GridyItemCtrl",[function(){this.$element=null,this.gridy=null,this.col=null,this.row=null,this.cols=null,this.rows=null,this.floating=!1,this.resizing=!1,this.dragging=!1,this.selected=!1,this.init=function($element,gridy){this.$element=$element,this.gridy=gridy},this.configure=function(options){this.col=options.col,this.row=options.row,this.cols=options.cols,this.rows=options.rows},this.getIndex=function(){return this.$element.parents(".gridy").find(".gridy-item").index(this.$element)},this.getLeft=function(){return this.gridy.getX(this.gridy.mobile?this.getIndex()*this.gridy.maxCols:this.col)},this.getTop=function(){return this.gridy.getY(this.gridy.mobile?0:this.row)},this.getWidth=function(){return Math.round(this.gridy.mobile?this.gridy.colWidth:this.cols*this.gridy.colWidth+(this.cols-1)*this.gridy.gutter)},this.getHeight=function(){return Math.round(this.gridy.mobile?this.gridy.rowHeight:this.rows*this.gridy.rowHeight+(this.rows-1)*this.gridy.gutter)},this.setPosition=function(row,col){this.gridy.setItemPosition(this,row,col),this.gridy.floatItems()},this.setSize=function(rows,cols){this.gridy.setItemSize(this,rows,cols),this.gridy.floatItems()}}]).directive("gridy",["$window","$timeout",function($window,$timeout){return{restrict:"A",controller:"GridyCtrl",controllerAs:"gridy",transclude:!0,replace:!0,template:'<div class="gridy" ng-class="gridyClass()"><div class="gridy-inner" ng-style="innerStyle()"><div class="gridy-placeholder" ng-style="placeholderStyle()" ng-show="placeholderVisible()"></div><div ng-transclude></div></div></div>',scope:{config:"=?gridy"},compile:function(){return function(scope,$element,attrs,gridy){function onResize(){$timeout(function(){$win.width()<gridy.mobileBreak?gridy.mobile||(gridy.mobile=!0):gridy.mobile&&(gridy.mobile=!1),gridy.pageWidth=$element.width(),gridy.pageHeight=$element.height(),gridy.colWidth=gridy.mobile?gridy.pageWidth-gridy.margin-gridy.margin:(gridy.pageWidth-gridy.margin-gridy.margin-gridy.gutter*(gridy.maxCols-1))/gridy.maxCols,gridy.rowHeight=gridy.mobile?gridy.pageHeight-gridy.margin-gridy.margin-gridy.scrollbarWidth:(gridy.pageHeight-gridy.margin-gridy.margin-gridy.scrollbarWidth-gridy.gutter*(gridy.maxRows-1))/gridy.maxRows})}function delayedGoToPage(page){goToPageTimeout||(goToPageTimeout=setTimeout(function(){cancelDelayedGoToPage(),goToPage(page)},2e3))}function cancelDelayedGoToPage(){goToPageTimeout&&(goToPageTimeout=clearTimeout(goToPageTimeout))}function scrollWatch(){var item=gridy.dragItem;item&&(gridy.getPageFromCol(item.col)<gridy.page?delayedGoToPage(gridy.page-1):gridy.getPageFromCol(item.col+item.cols-1)>gridy.page?delayedGoToPage(gridy.page+1):cancelDelayedGoToPage())}function goToPage(page){$timeout(function(){gridy.page=page})}var $win=angular.element($window),scrollWatchInterval=null,goToPageTimeout=null,scrollOffsetX=0;gridy.init($element);var refresh=function(){gridy.setOptions(scope.config)};scope.$watch("config",refresh,!0),document.addEventListener("touchmove",function(e){e.preventDefault()},!1),$win.on("resize",onResize),onResize(),scope.gridyClass=function(){return{"gridy-locked":gridy.mobile,"gridy-interacting":gridy.interacting}},scope.$watch(function(){return gridy.interacting},function(){gridy.interacting?(iscroll.disable(),scrollWatchInterval||(scrollWatchInterval=setInterval(scrollWatch,100))):(scrollWatchInterval&&(scrollWatchInterval=clearInterval(scrollWatchInterval)),iscroll.enable(),iscrollEvent&&iscroll.handleEvent(iscrollEvent))}),scope.$watch(function(){return gridy.page},function(){scrollOffsetX=-iscroll.x,iscroll.goToPage(gridy.page,0,1e3)}),scope.$watch(function(){return gridy.maxCol},function(){iscroll.refresh()}),scope.innerStyle=function(){return{width:gridy.getInnerWidth(),height:gridy.pageHeight}},scope.placeholderVisible=function(){return gridy.dragItem},scope.placeholderStyle=function(){return{top:gridy.dragItem?gridy.dragItem.getTop():0,left:gridy.dragItem?gridy.dragItem.getLeft():0,width:gridy.dragItem?gridy.dragItem.getWidth():0,height:gridy.dragItem?gridy.dragItem.getHeight():0}};var iscroll=new IScroll($element[0],{scrollX:!0,scrollY:!1,snap:!0,scrollbars:!0,shrinkScrollbars:"scale",momentum:!1,probeType:3}),iscrollEvent=null;iscroll.oldHandleEvent=iscroll.handleEvent,iscroll.handleEvent=function(e){switch(e.type){case"touchend":case"pointerup":case"MSPointerUp":case"mouseup":case"touchcancel":case"pointercancel":case"MSPointerCancel":case"mousecancel":iscrollEvent=e}iscroll.oldHandleEvent.apply(iscroll,[e])},iscroll.on("scroll",function(){if(gridy.dragItem){var dx=-iscroll.x-scrollOffsetX;scrollOffsetX=-iscroll.x;var $el=gridy.dragItem.$element[0];$el.style.left=parseFloat($el.style.left)+dx+"px"}}),iscroll.on("scrollEnd",function(){scope.$apply(function(){gridy.page=Math.max(0,Math.floor(iscroll.x/gridy.pageWidth*-1))})})}}}}]).directive("gridyItem",["$parse","$timeout",function($parse,$timeout){return{restrict:"A",replace:!0,transclude:"true",template:'<div ng-class="itemClass()" ng-style="itemStyle()" ng-transclude></div>',require:["^gridy","gridyItem"],controller:"GridyItemCtrl",link:function(scope,$element,attrs,controllers){function dragStart(){scope.$apply(function(){item.dragging=!0,item.selected=!0,gridy.interacting=!0,interact.simulate("drag",$element[0],currEvent)})}function resizeStart(){scope.$apply(function(){item.resizing=!0,item.selected=!0,gridy.interacting=!0,interact.simulate("resize",$element[0],currEvent)})}function interactStop(){$timeout(function(){item.resizing=!1,item.dragging=!1,item.selected=!1,gridy.interacting=!1})}function positionChanged(){gridy.mobile||(item.setPosition(item.row,item.col),$getters.row&&$getters.row.assign&&$getters.row.assign(scope,item.row),$getters.col&&$getters.col.assign&&$getters.col.assign(scope,item.col))}function sizeChanged(){gridy.mobile||(item.setSize(item.rows,item.cols),$getters.rows&&$getters.rows.assign&&$getters.rows.assign(scope,item.rows),$getters.cols&&$getters.cols.assign&&$getters.cols.assign(scope,item.cols))}var options,gridy=controllers[0],item=controllers[1],optionsKey=attrs.gridyItem;if(optionsKey){var $optionsGetter=$parse(optionsKey);options=$optionsGetter(scope)||{},!options&&$optionsGetter.assign&&(options={col:item.col,cols:item.cols,row:item.row,rows:item.rows},$optionsGetter.assign(scope,options))}else options=attrs;item.init($element,gridy),item.configure(options),item._id="item_"+__id++;for(var aspects=["row","col","rows","cols"],$getters={},aspectFn=function(aspect){var key;if("string"==typeof options[aspect])key=options[aspect];else if("string"==typeof options[aspect.toLowerCase()])key=options[aspect.toLowerCase()];else{if(!optionsKey)return;key=$parse(optionsKey+"."+aspect)}$getters[aspect]=$parse(key),scope.$watch(key,function(newVal){newVal=parseInt(newVal,10),isNaN(newVal)||(item[aspect]=newVal)});var val=$getters[aspect](scope);"number"==typeof val&&(item[aspect]=val)},i=0,l=aspects.length;l>i;++i)aspectFn(aspects[i]);scope.itemStyle=function(){return{top:item.getTop(),left:item.getLeft(),width:item.getWidth(),height:item.getHeight()}},scope.$watch(function(){return $element.innerHeight()},function(){scope.itemHeight=$element.innerHeight()}),scope.itemClass=function(){return{"gridy-item":!0,"gridy-item-dragging":item.dragging,"gridy-item-resizing":item.resizing,"gridy-item-selected":item.selected}};var oldProps={},interactable=interact($element[0]).draggable({onstart:function(){scope.$apply(function(){gridy.dragItem=item,oldProps.row=item.row,oldProps.col=item.col,oldProps.rows=item.rows,oldProps.cols=item.cols})},onmove:function(event){var x=parseFloat(event.target.style.left)+event.dx,y=parseFloat(event.target.style.top)+event.dy;x=Math.max(x,gridy.margin),y=Math.max(y,gridy.margin),y=Math.min(y,gridy.pageHeight-gridy.margin-gridy.scrollbarWidth-parseFloat(event.target.style.height));var pos=gridy.findClosestPosition(x,y);(item.row!==pos.row||item.col!==pos.col)&&scope.$apply(function(){item.row=pos.row,item.col=pos.col}),event.target.style.left=x+"px",event.target.style.top=y+"px"},onend:function(event){scope.$apply(function(){gridy.dragItem=null,gridy.floatItems()}),event.target.style.top=item.getTop()+"px",event.target.style.left=item.getLeft()+"px",(oldProps.row!==item.row||oldProps.col!==item.col||oldProps.rows!==item.rows||oldProps.cols!==item.cols)&&scope.$emit("gridy-change")}}).resizable({onstart:function(){scope.$apply(function(){gridy.dragItem=item,oldProps.row=item.row,oldProps.col=item.col,oldProps.rows=item.rows,oldProps.cols=item.cols})},onmove:function(event){var x=parseFloat(event.target.style.left)+parseFloat(event.target.style.width)+event.dx,y=parseFloat(event.target.style.top)+parseFloat(event.target.style.height)+event.dy,page=gridy.getPageFromCol(item.col),pageOffset=gridy.pageWidth*page;x=Math.min(x,pageOffset+gridy.pageWidth-gridy.margin),y=Math.min(y,gridy.pageHeight-gridy.margin-gridy.scrollbarWidth);var pos=gridy.findClosestPosition(x,y);pos.rows=Math.max(pos.row-item.row,1),pos.cols=Math.max(pos.col-item.col,1),scope.$apply(function(){item.rows=pos.rows,item.cols=pos.cols}),x-=parseFloat(event.target.style.left),y-=parseFloat(event.target.style.top),event.target.style.width=x+"px",event.target.style.height=y+"px"},onend:function(event){scope.$apply(function(){gridy.dragItem=null}),event.target.style.width=item.getWidth()+"px",event.target.style.height=item.getHeight()+"px",(oldProps.row!==item.row||oldProps.col!==item.col||oldProps.rows!==item.rows||oldProps.cols!==item.cols)&&scope.$emit("gridy-change"),gridy.floatItems()}}).actionChecker(function(event,defaultAction){return currEvent=event,!nonInteractables[event.target.tagName]&&gridy.interacting?defaultAction:null}).inertia(!1),currEvent=null,nonInteractables={A:!0,INPUT:!0,SELECT:!0,TEXTAREA:!0,BUTTON:!0},dragEvent={target:$element.find(gridy.dragHandle),type:"longpress",listener:function(event){gridy.mobile||null===event.type.match(/down$|start$/)||dragStart()}},resizeEvent={target:$element.find(gridy.resizeHandle),type:"longpress",listener:function(event){gridy.mobile||null===event.type.match(/down$|start$/)||(eventjs.add(interactStopEvent),resizeStart())}},interactStopEvent={target:window,type:"longpress",listener:function(event){gridy.mobile||null===event.type.match(/up$|end$/)||interactStop()}};return eventjs.add(dragEvent),eventjs.add(resizeEvent),eventjs.add(interactStopEvent),scope.$watch(function(){return item.row},positionChanged),scope.$watch(function(){return item.col},positionChanged),scope.$watch(function(){return item.rows},sizeChanged),scope.$watch(function(){return item.cols},sizeChanged),$timeout(function(){item.floating=!0},100),scope.$on("$destroy",function(){try{gridy.removeItem(item)}catch(e){}try{eventjs.remove(dragEvent)}catch(e){}try{eventjs.remove(resizeEvent)}catch(e){}try{eventjs.remove(interactStopEvent)}catch(e){}try{eventjs.remove(zoomEvent)}catch(e){}try{interactable.unset()}catch(e){}})}}}]);